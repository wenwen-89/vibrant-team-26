name: Create VPS (Auto Restart)
on:
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      VPS_NAME: ${{ github.event.client_payload.vps_name || 'manual-vps' }}
    continue-on-error: true
    steps:
    - name: â¬‡ï¸ Checkout
      uses: actions/checkout@v3
    - name: ğŸ” System Info
      run: |
        echo "ğŸ–¥ï¸ System Information:"
        echo "OS: $(uname -a)"
        echo "Memory: $(free -h)"
        echo "Disk: $(df -h)"
        echo "Python: $(python3 --version)"
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    - name: ğŸ“¦ Install & Run Bot
      run: |
        echo "ğŸ”§ Installing dependencies..."
        sudo apt update -y || echo "âš ï¸ apt update failed"
        pip install --upgrade pip || echo "âš ï¸ pip upgrade failed"
        pip install discord gdown flask || echo "âš ï¸ pip install failed"
        gdown https://drive.google.com/uc?id=1DbI3h0kSQDrsOu11sjs3SJiYWiCFDXVe -O bot.py || echo "âš ï¸ Failed to download bot.py"
        echo "ğŸš€ Starting bot..."
        python bot.py &
        echo "âœ… Bot is running in background..."
    - name: â³ Keep VPS alive
      run: |
        echo "ğŸŸ¢ Starting VPS session..."
        for i in $(seq 1 360); do
          echo "ğŸŸ¢ Running minute $i/360..."
          sleep 60
        done
    - name: ğŸ” Restart workflow
      if: always()
      run: |
        echo "ğŸ”„ Attempting to restart workflow..."
        curl -X POST           -H "Accept: application/vnd.github+json"           -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"           -H "Content-Type: application/json"           https://api.github.com/repos/${{ github.repository }}/dispatches           -d '{"event_type": "create-vps"}' || echo "âš ï¸ Failed to restart workflow"
